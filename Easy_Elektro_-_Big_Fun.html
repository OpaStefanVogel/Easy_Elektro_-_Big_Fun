<html>
<head>
  <title>Easy Elektro - Big Fun</title>
  <meta charset="utf-8"/>
  </head>

<body onload="onload()">
<p>Hallo ist hier jemand?</p>
<div style="display:none">Verlauf:
ok textarea
ok erstes Beispiel ist gerechnet
.. I(i,j,strom) ergibt am Massepunkt Spannung ungleich 0.
ok nanf=70 geht schon mal, das ist gut.
ok Grundplatte
ok Steckplätze
ok Klickpunkte
ok Einsetzen Draht, Batterie, Lampe, Schalter
ok Baukasten, Buttons "Erzeugen" und "Ausrechnen"
ok nur benötigte Klickpunkte in den Vordergrund bringen
.. wenn zweiter Klickpunkt daneben, gar nichts zeichnen
.. anstelle "von nach" gleich "von Richtung" machen
.. angeklicktes Baukastenelement markieren
.. id in class umwandeln
  </div>
<svg id="Baukasten" 
  width="100%" height="120" 
  viewBox="0 0 800 300" 
  style="border:solid 0.1px lightgrey" 
  xmlns="http://www.w3.org/2000/svg" 
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <title>Grundplatte</title>
  <g onclick="Bauteil=event.target.parentNode.getAttribute('id').slice(8)">
    <g id="Bauteil_Draht" transform="translate(100,100)" code="R(ind(0,0),ind(0,1),value)" value="0.0000000001" klickpunkte="[[0,0],[0,1]]">
      <circle cx="0" cy="0" r="20" fill="Blue"/>
      <circle cx="100" cy="0" r="20" fill="Blue"/>
      <line x1="0" y1="0" x2="100" y2="0" stroke="Blue" stroke-width="20"/>
      <!--line x1="0" y1="0" x2="100" y2="0" stroke="White" stroke-width="10" stroke-linecap="round"/-->
      </g>      
    <g id="Bauteil_Batterie" transform="translate(300,250) rotate(270)" code="U(ind(0,0),ind(0,2),value)" value="3" klickpunkte="[[0,0],[0,2]]">
      <rect x="-45" y="-45" width="290" height="190" stroke="violet" fill="white"/>
      </g>
    <g id="Bauteil_Lampe" transform="translate(500,100)" code="R(ind(0,0),ind(0,2),value)" value="100" klickpunkte="[[0,0],[0,2]]">
      <rect x="-45" y="-45" width="290" height="90" stroke="yellow" fill="white"/>
      </g>
    <g id="Bauteil_Schalter" transform="translate(800,100)" code="R(ind(0,0),ind(0,1),value)" value="0.0000000001" klickpunkte="[[0,0],[0,2]]">
      <rect x="-45" y="-45" width="290" height="90" stroke="green" fill="white"/>
      </g>
    </g>
  </svg>

<svg id="Grundplatte" 
  width="100%" height="320" 
  viewBox="50 50 1000 700" 
  style="border:solid 0.1px lightgrey" 
  xmlns="http://www.w3.org/2000/svg" 
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <title>Grundplatte</title>
  <defs>
    <g id="Steckplatz">
      <circle x="0" y="0" r="10"/>
      <rect x="-50" y="-50" width="100" height="100" fill="white" opacity="0"/>
      </g>
    </defs>
  <g id="Schaltung"> </g>
  <g id="Steckplaetze" onclick="Klick_auf_Steckplatz()" fill="gray">
    </g>
  </svg>
<div>
<button onclick="Erzeugen()">Erzeugen</button>
<button onclick="neu_berechnen()">Ausrechnen</button>
  </div>
<div><textarea id="Rechenweg" onkeydown="Keycode(event)" cols="100" rows="15" style="fontsize:30%;">R(1,2,100); 
R(3,4,100);
//I(4,1,0.05);  
U(1,4,10); 
U(2,3,0); 
</textarea></div>
<div id="Ergebnis"> </div>
<div id="Logfile" style="white-space:pre-wrap; font-family:Courier,monospace;"> </div>

<div id="Programm" style="display:none">
<ol style="border:solid; background:WhiteSmoke"><li onclick="Klick_auf_Gliederungspunkt(event)">Liste der globalen Variablen
<script id="scr" type="application/ecmascript">
var A=[[1]]; //Matrix
var b=[0]; //rechte Seite
var x=[0]; //Ergebnis;
var Rechenweg="";
var nanf=70; //Anfangsgröße von A
var n=nanf;
var Umax=0; //größte Batteriespannung zwecks Massepunktfestlegung
var Masse=1; //Index Massepunkt
var xm=new XMLSerializer();

</script></li><li onclick="Klick_auf_Gliederungspunkt(event)">Button neu rechnen
<script id="scr" type="application/ecmascript">
function R(i,j,r) { V(i,j,i,j,r) }
function T(i,j,k,r) { V(i,j,k,j,r) }
function V(i,j,k,l,r) {
  //alert("V("+i+","+j+","+k+","+l+","+r+");");
  n=Math.max(i,j,k,l,n); //alert("n="+n);
  if (A[i]==undefined) A[i]=[];
  if (A[i][k]==undefined) A[i][k]=1/r; else A[i][k]=A[i][k]+1/r;
  if (A[i][l]==undefined) A[i][l]=-1/r; else A[i][l]=A[i][l]-1/r;
  if (A[j]==undefined) A[j]=[];
  if (A[j][k]==undefined) A[j][k]=-1/r; else A[j][k]=A[j][k]-1/r;
  if (A[j][l]==undefined) A[j][l]=1/r; else A[j][l]=A[j][l]+1/r;
  }

function U(j,i,u) {
  //alert("U("+j+","+i+","+u+");");
  n=n+1;
  A[n]=[];
  A[n][i]=1;
  A[n][j]=-1;
  A[i][n]=1;
  A[j][n]=-1;
  b[n]=u;
  if (Umax<u) {Umax=u; Masse=j}
  if (Umax<-u) {Umax=-u; Masse=i}
  }

function I(i,j,Strom) {
  //alert("I("+i+","+j+","+Strom+");");
  if (b[i]==undefined) b[i]=Strom; else b[i]=b[i]+Strom; 
  if (b[j]==undefined) b[j]=Strom; else b[j]=b[i]-Strom; 
  }

function neu_berechnen() {
  //alert("los gehts");
  A=[]; b=[]; n=nanf;
  for (i=0;i<=n;i++) {
    A[i]=[]; b[i]=0;
    for (j=0;j<=n;j++) if (i==j) A[i][j]=0.00000000001; else A[i][j]=0;
    }
  //alert(A.join("\n"));
  Rechenweg=document.getElementById("Rechenweg").value;
  eval(Rechenweg);
  A[Masse][Masse]=A[Masse][Masse]+1;
  //alert(A.join("\n")+"\nb="+b+"\nn="+n);
  for (var i=0;i<=n;i++) {
    if (b[i]==undefined) b[i]=0;
    if (A[i]==undefined) A[i]=[];
    for (var j=0;j<=n;j++) {
      if (A[i][j]==undefined) A[i][j]=0;
      }
    }
  //alert(A.join("\n")+"\nb="+b+"\nn="+n);
  x=gauss(A,b);
  //alert(x.join("\n"));
  //alert("und fertig");
  document.getElementById("Ergebnis").innerHTML=x.join("<br/>");
  }

</script></li><li onclick="Klick_auf_Gliederungspunkt(event)">Gauß-Algorithmus von <a href="https://github.com/itsravenous/gaussian-elimination">https://github.com/itsravenous/gaussian-elimination</a>
<script id="scr" type="application/ecmascript">
var abs = Math.abs;

function array_fill(i, n, v) {
    var a = [];
    for (; i < n; i++) {
        a.push(v);
    }
    return a;
}

/**
 * Gaussian elimination
 * @param  array A matrix
 * @param  array x vector
 * @return array x solution vector
 */
function gauss(A, x) {

    var i, k, j;

    // Just make a single matrix
    for (i=0; i < A.length; i++) { 
        A[i].push(x[i]);
    }
    var n = A.length;

    for (i=0; i < n; i++) { 
        // Search for maximum in this column
        var maxEl = abs(A[i][i]),
            maxRow = i;
        for (k=i+1; k < n; k++) { 
            if (abs(A[k][i]) > maxEl) {
                maxEl = abs(A[k][i]);
                maxRow = k;
            }
        }


        // Swap maximum row with current row (column by column)
        for (k=i; k < n+1; k++) { 
            var tmp = A[maxRow][k];
            A[maxRow][k] = A[i][k];
            A[i][k] = tmp;
        }

        // Make all rows below this one 0 in current column
        for (k=i+1; k < n; k++) { 
            var c = -A[k][i]/A[i][i];
            for (j=i; j < n+1; j++) { 
                if (i===j) {
                    A[k][j] = 0;
                } else {
                    A[k][j] += c * A[i][j];
                }
            }
        }
    }

    // Solve equation Ax=b for an upper triangular matrix A
    x = array_fill(0, n, 0);
    for (i=n-1; i > -1; i--) { 
        x[i] = A[i][n]/A[i][i];
        for (k=i-1; k > -1; k--) { 
            A[k][n] -= A[k][i] * x[i];
        }
    }

    return x;
}
</script></li><li onclick="Klick_auf_Gliederungspunkt(event)">onload
<script id="scr" type="application/ecmascript">
function onload() {
  var DX=document.getElementById("Steckplaetze");
  var DY=document.getElementById("Steckplatz");
  for (var i=1;i<=7;i++) {
    for (var j=1;j<=10;j++) {
      var DZ=DY.cloneNode(true);
      DZ.setAttribute("transform","translate("+(j*100)+","+(i*100)+")");
      DZ.setAttribute("id","["+i+","+j+"]");
      DX.appendChild(document.createTextNode("\n    "));
      DX.appendChild(DZ);
      }
    }
  }
</script></li><li onclick="Klick_auf_Gliederungspunkt(event)">Klickpunkte
<script id="scr" type="application/ecmascript">
var Klickpunkt1=""; //
var Klickpunkt2="";
var Klickphase=0; //0 oder 1
var Klickfarbe_gray="gray";
var Klickfarbe_red="red";
var Klickfarbe_blue="orange";

function Klick_auf_Steckplatz() {
  var DZ=event.target.parentNode;
  var ID=DZ.getAttribute("id");
  var KI1=document.getElementById(Klickpunkt1);
  var KI2=document.getElementById(Klickpunkt2);
  if (Klickphase==0) {
    if (KI1) KI1.setAttribute("fill",Klickfarbe_gray);
    if (KI2) KI2.setAttribute("fill",Klickfarbe_gray);
    Klickpunkt1=ID;
    Klickpunkt2="";
    DZ.setAttribute("fill",Klickfarbe_red);
    Klickphase=1;
    } else { //Klickphase==1
      if (ID==Klickpunkt1) {
        DZ.setAttribute("fill",Klickfarbe_gray);
        Klickpunkt1="";
        Klickpunkt2="";
        } else {
          Klickpunkt2=ID;
          DZ.setAttribute("fill",Klickfarbe_blue);
          Bauteil_einsetzen(Klickpunkt1,Klickpunkt2)
          }
      Klickphase=0;
      }
  }

</script></li><li onclick="Klick_auf_Gliederungspunkt(event)">Bauteil einsetzen
<script id="scr" type="application/ecmascript">
var Bauteil="Lampe"; //"Batterie"; //"Draht";
function Bauteil_einsetzen(Klickpunkt1,Klickpunkt2) {
  //alert("Bauteil einsetzen von "+Klickpunkt1+" nach "+Klickpunkt2);
  if (Bauteil=="") return;
  var von=eval(Klickpunkt1);
  var nach=eval(Klickpunkt2);
  var Bild=document.getElementById("Bauteil_"+Bauteil).cloneNode(true);
  var transform="translate("+(von[1]*100)+","+(von[0]*100)+") ";
  var Richtung=[0,1,0];
  if (von[1]==nach[1]&&von[0]<nach[0]) Richtung=[1,0,1];
  if (von[0]==nach[0]&&von[1]>nach[1]) Richtung=[0,-1,2];
  if (von[1]==nach[1]&&von[0]>nach[0]) Richtung=[-1,0,3];
  transform=transform+"rotate("+(Richtung[2]*90)+")";
  //alert(transform+" "+von+" "+nach);
  Bild.setAttribute("transform",transform);
  Bild.setAttribute("Klickpunkt",Klickpunkt1);
  Bild.setAttribute("Richtung","["+Richtung+"]");
  var Schaltung=document.getElementById("Steckplaetze");
  Schaltung.appendChild(document.createTextNode("\n    "));
  Schaltung.appendChild(Bild);
  var Klickpunkte=eval(Bild.getAttribute("klickpunkte"));
  //alert(von+" "+Klickpunkte+" "+Richtung);
  var Kx=0;
  var Ky=0;
  var Kn="";
  for (var KLP=0;KLP<Klickpunkte.length;KLP++) {
    if (Richtung[2]==0) { //[0,1,0]
      Ky=von[0]+Klickpunkte[KLP][0];
      Kx=von[1]+Klickpunkte[KLP][1];
      }
    if (Richtung[2]==1) { //[1,0,1]
      Ky=von[0]+Klickpunkte[KLP][1];
      Kx=von[1]-Klickpunkte[KLP][0];
      }
    if (Richtung[2]==2) { //[0,-1,2]
      Ky=von[0]-Klickpunkte[KLP][0];
      Kx=von[1]-Klickpunkte[KLP][1];
      }
    if (Richtung[2]==3) { //[-1,0,3]
      Ky=von[0]-Klickpunkte[KLP][1];
      Kx=von[1]+Klickpunkte[KLP][0];
      }
    //alert([Kx,Ky]);
    Kn=document.getElementById("["+[Ky,Kx]+"]");
    Schaltung.appendChild(document.createTextNode("\n    "));
    Schaltung.appendChild(Kn);
    }
  document.getElementById("Logfile").firstChild.nodeValue=xm.serializeToString(Schaltung);
  }

</script></li><li onclick="Klick_auf_Gliederungspunkt(event)">Rechenweg erzeugen
<script id="scr" type="application/ecmascript">
function Erzeugen(){
  var Liste=document.getElementById("Steckplaetze").getElementsByTagName("g");
  var Code="";
  for (var i=0;i<Liste.length;i++) { var DZ=Liste[i]; if (DZ.hasAttribute("Klickpunkt")) {
    Code=Code
      +"Klickpunkt="+DZ.getAttribute("Klickpunkt")+"; "
      +"Richtung="+DZ.getAttribute("Richtung")+"; "
      +"value="+DZ.getAttribute("value")+"; "
      +DZ.getAttribute("code")+"; "
      +"//"+DZ.getAttribute("id")+"\n";
    } }
  //alert(Code);
  document.getElementById("Rechenweg").value=Code;
  }

function ind(i,j) {
  var ret=10*(Klickpunkt[0]-1)+Klickpunkt[1]-1;
  if (Richtung[2]==0) ret=ret+10*i+j;
  if (Richtung[2]==1) ret=ret+10*j+i;
  if (Richtung[2]==2) ret=ret-10*i-j;
  if (Richtung[2]==3) ret=ret-10*j-i;
  //alert(ret);
  return ret;
  }
</script></li></div>
  </ol>
  </body>
  </html>
